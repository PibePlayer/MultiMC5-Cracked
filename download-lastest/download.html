<html>
  <head>
    <title>Redirecting to Lastest Download...</title>
    <script>
      var artifact_url;
      var token;
      var fileName = "MultiMC.zip";
      var url = 'https://api.github.com/repos/PibePlayer/MultiMC5-Cracked/actions/artifacts';
      // 1. New Object XMLHttpRequest
      var artifact_xhr = new XMLHttpRequest();

      // 2. Config it 
      artifact_xhr.open('GET', url, true);
      artifact_xhr.responseType = 'json';

      artifact_xhr.onload  = function() {
        var jsonResponse = artifact_xhr.response;
        console.log(jsonResponse.artifacts[0]);
        fileName = jsonResponse.artifacts[0].name + ".zip";
        artifact_url = jsonResponse.artifacts[0].archive_download_url;

        //location.replace(jsonResponse.artifacts[0].archive_download_url);
        // do something with jsonResponse
      };

      // 3. Send request
      artifact_xhr.send();
      
      function extractUrlValue(key, url)
      {
          if (typeof(url) === 'undefined')
              url = window.location.href;
          var match = url.match('[?&]?' + key + '=([^&]+)');
          return match ? match[1] : null;
      }
      
      var url = new URL(window.location);
      var code = url.searchParams.get("code");
      if(code){
        var url2 = " https://cors-anywhere.herokuapp.com/https://github.com/login/oauth/access_token";
        var params = "client_id=4fc6c743790019440d8e&redirect_uri=https://pibeplayer.github.io/MultiMC5-Cracked/download-lastest/download.html&client_secret=558c744e1f19d75a530eb2fa6bfa15d655580bf0&code=" + code;
        
        var token_xhr = new XMLHttpRequest();

        // 2. Config it 
        token_xhr.open('POST', url2, true);
        token_xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        //xhr.responseType = 'json';

        token_xhr.onload  = function() {
           var jsonResponse = token_xhr.response;
           token = extractUrlValue("access_token", jsonResponse)
           console.log(token);
           //location.replace(jsonResponse.artifacts[0].archive_download_url);
           // do something with jsonResponse
          
            /*var request = new XMLHttpRequest();

            request.open( '', file, true );
            request.responseType = "arraybuffer";

            request.onreadystatechange = () => {

                // Do nothing if we are not ready yet
                if ( request.readyState !== XMLHttpRequest.DONE ) { return; }

                if ( request.status === 200 ) {
                    callback( new Blob( [request.response], { type : "application/zip" } ) );
                } else {
                    console.error( request.status );
                    callback( false );
                }

            };

            request.send();*/
          
            var url = 'https://api.github.com/repos/PibePlayer/MultiMC5-Cracked/actions/artifacts';
            // 1. New Object XMLHttpRequest
            var redir_xhr = new XMLHttpRequest();
          
            // 2. Config it 
            redir_xhr.open('GET', artifact_url, true);
            redir_xhr.setRequestHeader('Content-Type', "application/vnd.github.v3+json");
            //redir_xhr.setRequestHeader('Content-Type', "application/zip");
            //redir_xhr.responseType = "arraybuffer";
            //redir_xhr.responseType = "blob";
            redir_xhr.setRequestHeader("Authorization", "token " + token);
            //xhr.responseType = 'json';
          
            /*redir_xhr.onreadystatechange = () => {

                // Do nothing if we are not ready yet
                if ( redir_xhr.readyState !== XMLHttpRequest.DONE ) { return; }

                if ( redir_xhr.status === 200 ) {
                    new Blob( [redir_xhr.response], { type : "application/zip" } );
                } else {
                    console.error( request.status );
                }

            };*/

            /*redir_xhr.onload  = function() {
              var redir = redir_xhr.response;
              console.log(redir);
              //const file = new File(redir, "MultiMC.zip", {type: 'application/zip'});
            }*/
          
            function str2bytes (str) {
               var bytes = new Uint8Array(str.length);
               for (var i=0; i<str.length; i++) {
                  bytes[i] = str.charCodeAt(i);
                }
                return bytes;
            }
          
            /*redir_xhr.onreadystatechange = function() {
              if (redir_xhr.readyState == 4 && redir_xhr.status == 200) {
                // alert("Failed to download:" + xhr.status + "---" + xhr.statusText);
                var blob = new Blob([str2bytes(redir_xhr.response)], {type: "application/zip"});
                
                if (navigator.msSaveOrOpenBlob) {
                  navigator.msSaveOrOpenBlob(blob, fileName);
                } else {
                  var a = document.createElement("a");
                  document.body.appendChild(a);
                  a.style = "display:none";
                  var url = window.URL.createObjectURL(blob);
                  a.href = url;
                  a.download = fileName;
                  a.click();
                  window.URL.revokeObjectURL(url);
                  a.remove();
                }
              }
            }*/
          
            redir_xhr.onreadystatechange = function() {
                if (redir_xhr.readyState >= 2) {
                  console.log(redir_xhr.responseURL);
                  location.replace(redir_xhr.responseURL);
                }
              }
            
            /*redir_xhr.onload = function(e) {
              console.log(redir_xhr.responseURL);
              location.replace(redir_xhr.responseURL);
              /*if (this.status == 200) {
                var data = this.response;
                //const blob = new Blob(data, {type: 'application/octet-stream'});
                const blob2 = new Blob(data, {type: 'application/zip'});
                const file = new File(blob2, "M1" + fileName, {type: 'application/zip'});
              }
              
            }*/
          
            /*redir_xhr.onload  = function() {
              if (redir_xhr.status == 200) {
                var data = redir_xhr.response;
                const blob = new Blob(data, {type: 'application/octet-stream'});
                const file = new File(blob, filename, {type: 'application/zip'});
                this.handleUpload(file);
              }
            }*/
          
            redir_xhr.send();
        };

        // 3. Send request
        token_xhr.send(params);
      }
    </script>
  </head>
</html>
