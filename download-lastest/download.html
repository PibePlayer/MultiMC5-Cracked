<html>
  <head>
    <title>Redirecting to Lastest Download...</title>
    <script>
      var artifact_url;
      var token;
      var url = 'https://api.github.com/repos/PibePlayer/MultiMC5-Cracked/actions/artifacts';
      // 1. New Object XMLHttpRequest
      var artifact_xhr = new XMLHttpRequest();

      // 2. Config it 
      artifact_xhr.open('GET', url, true);
      artifact_xhr.responseType = 'json';

      artifact_xhr.onload  = function() {
        var jsonResponse = artifact_xhr.response;
        console.log(jsonResponse.artifacts[0].archive_download_url);
        artifact_url = jsonResponse.artifacts[0].archive_download_url;

        //location.replace(jsonResponse.artifacts[0].archive_download_url);
        // do something with jsonResponse
      };

      // 3. Send request
      artifact_xhr.send();
      
      function extractUrlValue(key, url)
      {
          if (typeof(url) === 'undefined')
              url = window.location.href;
          var match = url.match('[?&]?' + key + '=([^&]+)');
          return match ? match[1] : null;
      }
      
      var url = new URL(window.location);
      var code = url.searchParams.get("code");
      if(code){
        var url2 = " https://cors-anywhere.herokuapp.com/https://github.com/login/oauth/access_token";
        var params = "client_id=4fc6c743790019440d8e&redirect_uri=https://pibeplayer.github.io/MultiMC5-Cracked/download-lastest/download.html&client_secret=558c744e1f19d75a530eb2fa6bfa15d655580bf0&code=" + code;
        
        var token_xhr = new XMLHttpRequest();

        // 2. Config it 
        token_xhr.open('POST', url2, true);
        token_xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        //xhr.responseType = 'json';

        token_xhr.onload  = function() {
           var jsonResponse = token_xhr.response;
           token = extractUrlValue("access_token", jsonResponse)
           console.log(token);
           //location.replace(jsonResponse.artifacts[0].archive_download_url);
           // do something with jsonResponse
          
            /*var request = new XMLHttpRequest();

            request.open( '', file, true );
            request.responseType = "arraybuffer";

            request.onreadystatechange = () => {

                // Do nothing if we are not ready yet
                if ( request.readyState !== XMLHttpRequest.DONE ) { return; }

                if ( request.status === 200 ) {
                    callback( new Blob( [request.response], { type : "application/zip" } ) );
                } else {
                    console.error( request.status );
                    callback( false );
                }

            };

            request.send();*/
          
            var url = 'https://api.github.com/repos/PibePlayer/MultiMC5-Cracked/actions/artifacts';
            // 1. New Object XMLHttpRequest
            var redir_xhr = new XMLHttpRequest();
          
            // 2. Config it 
            redir_xhr.open('GET', artifact_url, true);
            //redir_xhr.setRequestHeader('Content-Type', "application/vnd.github.v3+json");
            redir_xhr.responseType = "arraybuffer";
            redir_xhr.setRequestHeader("Authorization", "token " + token);
            //xhr.responseType = 'json';
          
            redir_xhr.onreadystatechange = () => {

                // Do nothing if we are not ready yet
                if ( redir_xhr.readyState !== XMLHttpRequest.DONE ) { return; }

                if ( redir_xhr.status === 200 ) {
                    new Blob( [redir_xhr.response], { type : "application/zip" } );
                } else {
                    console.error( request.status );
                }

            };

            /*redir_xhr.onload  = function() {
              var redir = redir_xhr.response;
              console.log(redir);
            }*/
            redir_xhr.send();
        };

        // 3. Send request
        token_xhr.send(params);
      }
    </script>
  </head>
</html>
